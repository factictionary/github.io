<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Number Merge - Improved</title>
<style>
body {
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  font-family: 'Segoe UI', sans-serif;
  color: white;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  margin: 0;
}
.container {
  width: 400px;
  text-align: center;
}
h1 {
  background: linear-gradient(to right, #4ade80, #22d3ee);
  -webkit-background-clip: text;
  color: transparent;
  font-size: 2.5rem;
  margin-bottom: 10px;
}
.game-board {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 5px;
  background-color: #0f1419;
  border: 2px solid #374151;
  border-radius: 10px;
  aspect-ratio: 1 / 1; /* Perfect square */
  padding: 5px;
  position: relative;
  margin-bottom: 20px;
}
.tile {
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  font-weight: bold;
  color: #fff;
  font-size: 1.5rem;
  aspect-ratio: 1 / 1;
  transition: all 0.2s ease;
}
.tile-2 { background: #ef4444; }
.tile-4 { background: #f59e0b; }
.tile-8 { background: #eab308; }
.tile-16 { background: #84cc16; }
.tile-32 { background: #22c55e; }
.tile-64 { background: #14b8a6; }
.tile-128 { background: #06b6d4; }
.tile-256 { background: #3b82f6; }
.tile-512 { background: #8b5cf6; }
.tile-1024 { background: #d946ef; }
.tile-2048 { background: #ec4899; }
.merge {
  animation: merge 0.3s ease;
}
@keyframes merge {
  0% { transform: scale(1); }
  50% { transform: scale(1.25); }
  100% { transform: scale(1); }
}
.controls {
  display: flex;
  justify-content: center;
  gap: 10px;
}
button {
  background: linear-gradient(to right, #4ade80, #22d3ee);
  border: none;
  color: white;
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: bold;
  cursor: pointer;
}
button:hover {
  opacity: 0.9;
}
.scoreboard {
  display: flex;
  justify-content: space-between;
  margin-bottom: 15px;
  background: rgba(30, 30, 46, 0.8);
  padding: 10px;
  border-radius: 8px;
}
</style>
</head>
<body>
<div class="container">
  <h1>Number Merge</h1>
  <div class="scoreboard">
    <div>Score: <span id="score">0</span></div>
    <div>Level: <span id="level">1</span></div>
  </div>
  <div class="game-board" id="game-board"></div>
  <div class="controls">
    <button id="left">⬅️</button>
    <button id="drop">⬇️</button>
    <button id="right">➡️</button>
  </div>
  <button id="restart" style="margin-top:15px;">New Game</button>
</div>

<script>
const ROWS = 8, COLS = 4;
let grid = Array(ROWS).fill().map(()=>Array(COLS).fill(0));
let score = 0, level = 1;
let fallingTile = null;
let gameOver = false;
let speed = 800;
let fallInterval;

const board = document.getElementById("game-board");
const scoreEl = document.getElementById("score");
const levelEl = document.getElementById("level");

function renderGrid() {
  board.innerHTML = "";
  grid.forEach(row=>{
    row.forEach(val=>{
      const cell=document.createElement("div");
      cell.classList.add("tile");
      if(val>0){
        cell.textContent=val;
        cell.classList.add(`tile-${val}`);
      }else{
        cell.style.background="rgba(255,255,255,0.05)";
      }
      board.appendChild(cell);
    });
  });
}

function spawnTile() {
  const val = Math.random()<0.7?2:4;
  const col = Math.floor(Math.random()*COLS);
  if(grid[0][col]!==0){ gameOver=true; alert("Game Over!"); return;}
  fallingTile={row:0,col,val};
  grid[0][col]=val;
  renderGrid();
}

function moveDown(){
  if(!fallingTile) return;
  const {row,col,val}=fallingTile;
  if(row<ROWS-1 && grid[row+1][col]===0){
    grid[row][col]=0;
    grid[row+1][col]=val;
    fallingTile.row++;
  }else{
    // landed
    fallingTile=null;
    checkMerges();
    applyGravity();
    spawnTile();
  }
  renderGrid();
}

function moveLeft(){
  if(!fallingTile) return;
  const {row,col,val}=fallingTile;
  if(col>0 && grid[row][col-1]===0){
    grid[row][col]=0;
    grid[row][col-1]=val;
    fallingTile.col--;
    renderGrid();
  }
}
function moveRight(){
  if(!fallingTile) return;
  const {row,col,val}=fallingTile;
  if(col<COLS-1 && grid[row][col+1]===0){
    grid[row][col]=0;
    grid[row][col+1]=val;
    fallingTile.col++;
    renderGrid();
  }
}

function applyGravity(){
  let moved=false;
  for(let r=ROWS-2;r>=0;r--){
    for(let c=0;c<COLS;c++){
      if(grid[r][c]!==0 && grid[r+1][c]===0){
        grid[r+1][c]=grid[r][c];
        grid[r][c]=0;
        moved=true;
      }
    }
  }
  if(moved){
    renderGrid();
    setTimeout(applyGravity,100);
  }
}

function checkMerges(){
  let merged=false;
  const visited=Array(ROWS).fill().map(()=>Array(COLS).fill(false));

  const dirs=[[1,0],[-1,0],[0,1],[0,-1]];

  function collect(r,c,val,cells){
    if(r<0||r>=ROWS||c<0||c>=COLS||visited[r][c]||grid[r][c]!==val) return;
    visited[r][c]=true;
    cells.push([r,c]);
    dirs.forEach(([dr,dc])=>collect(r+dr,c+dc,val,cells));
  }

  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(grid[r][c]!==0 && !visited[r][c]){
        let cells=[];
        collect(r,c,grid[r][c],cells);
        if(cells.length>1){
          merged=true;
          const [lowestR,lowestC]=cells.reduce((a,b)=>a[0]>b[0]?a:b);
          cells.forEach(([rr,cc])=>grid[rr][cc]=0);
          grid[lowestR][lowestC]=grid[r][c]*2;
          score+=grid[lowestR][lowestC];
        }
      }
    }
  }

  if(merged){
    scoreEl.textContent=score;
    if(score>=level*200){
      level++;
      levelEl.textContent=level;
      speed=Math.max(200,800-(level-1)*80);
      restartFallInterval();
    }
    renderGrid();
    setTimeout(()=>{
      applyGravity();
      setTimeout(checkMerges,150);
    },150);
  }
}

function restartFallInterval(){
  clearInterval(fallInterval);
  fallInterval=setInterval(()=>{if(!gameOver)moveDown();},speed);
}

function init(){
  grid=Array(ROWS).fill().map(()=>Array(COLS).fill(0));
  score=0; level=1; gameOver=false;
  scoreEl.textContent=score;
  levelEl.textContent=level;
  renderGrid();
  spawnTile();
  restartFallInterval();
}

document.getElementById("left").onclick=moveLeft;
document.getElementById("right").onclick=moveRight;
document.getElementById("drop").onclick=()=>{while(fallingTile && !gameOver)moveDown();};
document.getElementById("restart").onclick=init;
document.addEventListener("keydown",e=>{
  if(e.key==="ArrowLeft")moveLeft();
  if(e.key==="ArrowRight")moveRight();
  if(e.key==="ArrowDown")moveDown();
});

init();
</script>
</body>
</html>
